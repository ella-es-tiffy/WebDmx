<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DMX Monitor | 512 Channel View</title>
    <style>
        :root {
            --bg-dark: #0a0a0b;
            --bg-medium: #141417;
            --accent: #00f2ff;
            --text: #e0e0e0;
            --border: #2a2a2e;
        }

        body {
            margin: 0;
            padding: 20px;
            background-color: var(--bg-dark);
            color: var(--text);
            font-family: 'Inter', -apple-system, sans-serif;
            user-select: none;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border);
        }

        h1 {
            margin: 0;
            font-size: 18px;
            font-weight: 600;
            letter-spacing: 1px;
            color: var(--accent);
            text-transform: uppercase;
        }

        .stats {
            font-size: 12px;
            color: #888;
        }

        #dmx-grid {
            display: grid;
            grid-template-columns: repeat(16, 1fr);
            gap: 2px;
            background: var(--border);
            border: 1px solid var(--border);
        }

        .channel-cell {
            background: var(--bg-dark);
            height: 45px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            position: relative;
            transition: background 0.05s;
        }

        .channel-num {
            font-size: 9px;
            color: #555;
            position: absolute;
            top: 2px;
            left: 2px;
        }

        .channel-val {
            font-size: 14px;
            font-weight: bold;
            font-family: 'JetBrains Mono', monospace;
        }

        .bar {
            position: absolute;
            bottom: 0;
            left: 0;
            height: 3px;
            background: var(--accent);
            transition: width 0.1s;
        }

        @media (max-width: 1200px) {
            #dmx-grid {
                grid-template-columns: repeat(12, 1fr);
            }
        }

        @media (max-width: 800px) {
            #dmx-grid {
                grid-template-columns: repeat(8, 1fr);
            }
        }

        <style>

        /* ... previous root and body styles ... */
        .channel-label {
            font-size: 8px;
            color: #888;
            position: absolute;
            bottom: 6px;
            right: 2px;
            text-transform: uppercase;
        }

        /* Type Highlights */
        .type-dimmer {
            border-top: 2px solid #fff;
        }

        .type-red {
            border-top: 2px solid #ff4444;
        }

        .type-green {
            border-top: 2px solid #44ff44;
        }

        .type-blue {
            border-top: 2px solid #4444ff;
        }

        .type-white {
            border-top: 2px solid #ffff88;
        }

        .fixture-name {
            font-size: 7px;
            color: #444;
            position: absolute;
            top: 2px;
            right: 2px;
            max-width: 60%;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
    </style>
</head>

<body>
    <header>
        <h1>DMX Live Monitor</h1>
        <div class="stats" id="status">Connecting...</div>
    </header>

    <div id="dmx-grid"></div>

    <script>
        const API = `http://${window.location.hostname}:3000`;
        const grid = document.getElementById('dmx-grid');
        const cells = [];
        let channelMap = {}; // 1-512 -> { name, type, fixture }

        async function loadPatch() {
            try {
                const [devRes, assignRes] = await Promise.all([
                    fetch(`${API}/api/devices`),
                    fetch(`${API}/api/faders/all-assignments`)
                ]);
                const devices = await devRes.json();
                const assignments = await assignRes.json();

                const map = {};
                devices.forEach(dev => {
                    const start = dev.dmx_address;
                    const fixtureAssign = assignments.mapping[dev.id] || {};

                    Object.entries(fixtureAssign).forEach(([rel, funcs]) => {
                        const abs = start + parseInt(rel) - 1;
                        if (abs < 1 || abs > 512) return;

                        const func = Array.isArray(funcs) ? funcs[0].toLowerCase() : funcs.toLowerCase();
                        let type = 'other';
                        if (func === 'dim' || func === 'dimmer' || func === 'intensity') type = 'dimmer';
                        else if (func === 'red' || func === 'r') type = 'red';
                        else if (func === 'green' || func === 'g') type = 'green';
                        else if (func === 'blue' || func === 'b') type = 'blue';
                        else if (func === 'white' || func === 'w') type = 'white';

                        map[abs] = {
                            fixture: dev.name,
                            type: type,
                            label: func.substring(0, 3)
                        };
                    });
                });
                channelMap = map;
                initGrid();
            } catch (e) {
                console.error('Failed to load patch info:', e);
                initGrid();
            }
        }

        function initGrid() {
            grid.innerHTML = '';
            cells.length = 0;
            for (let i = 1; i <= 512; i++) {
                const info = channelMap[i];
                const cell = document.createElement('div');
                cell.className = 'channel-cell';
                if (info) cell.classList.add('type-' + info.type);

                const num = document.createElement('div');
                num.className = 'channel-num';
                num.textContent = i;

                if (info) {
                    const fName = document.createElement('div');
                    fName.className = 'fixture-name';
                    fName.textContent = info.fixture;
                    cell.appendChild(fName);

                    const label = document.createElement('div');
                    label.className = 'channel-label';
                    label.textContent = info.label;
                    cell.appendChild(label);
                }

                const val = document.createElement('div');
                val.className = 'channel-val';
                val.textContent = '0';

                const bar = document.createElement('div');
                bar.className = 'bar';
                if (info && info.type !== 'other') {
                    if (info.type === 'red') bar.style.backgroundColor = '#ff4444';
                    if (info.type === 'green') bar.style.backgroundColor = '#44ff44';
                    if (info.type === 'blue') bar.style.backgroundColor = '#4444ff';
                }

                cell.appendChild(num);
                cell.appendChild(val);
                cell.appendChild(bar);
                grid.appendChild(cell);

                cells.push({ el: cell, valTxt: val, bar: bar, type: info ? info.type : 'none' });
            }
        }

        async function update() {
            try {
                const res = await fetch(`${API}/api/dmx-output`);
                const data = await res.json();

                if (data.success && data.universe) {
                    data.universe.forEach((val, i) => {
                        const cell = cells[i];
                        if (!cell) return;

                        cell.valTxt.textContent = val;

                        const alpha = val / 255;
                        let baseColor = '0, 242, 255'; // Cyan default
                        if (cell.type === 'red') baseColor = '255, 68, 68';
                        else if (cell.type === 'green') baseColor = '68, 255, 68';
                        else if (cell.type === 'blue') baseColor = '68, 68, 255';
                        else if (cell.type === 'dimmer') baseColor = '255, 255, 255';

                        cell.el.style.backgroundColor = `rgba(${baseColor}, ${alpha * 0.25})`;
                        cell.valTxt.style.color = val > 0 ? '#fff' : '#444';
                        cell.bar.style.width = `${(val / 255) * 100}%`;
                        cell.bar.style.opacity = alpha > 0 ? Math.max(0.3, alpha) : 0;
                    });
                    document.getElementById('status').textContent = `LIVE | 512 Channels | ${new Date().toLocaleTimeString()}`;
                }
            } catch (e) {
                document.getElementById('status').textContent = 'Connection Error...';
            }
            requestAnimationFrame(() => setTimeout(update, 50));
        }

        loadPatch().then(() => update());
    </script>
</body>

</html>